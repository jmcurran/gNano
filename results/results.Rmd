---
title: "Results.Rmd"
author: "James Curran"
date: "28/06/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

## Model $g_0$ - no effects
```{r g0, echo=FALSE, fig.cap="Model $g_0$", out.width = '25%'}
knitr::include_graphics("g0.png")
```

**Model:**
$\mathrm{E}[y_{c,l,a}]) = \log(\mu)$
$\mathrm{Var}[y_{c,l,a}] = \sigma^2$


First I will load up the dat
```{r}
load("../systematic/g-0.Rda")
```

Given that we only have one chain, we might as well simultaneously pull the results out of the list, and turn the results into a data frame. This will make our code easier.

```{r}
g0.df = as.data.frame(as.matrix(sim.sample))
```


I'll do this with ggplot2 so I can teach myself something 
```{r}
library(ggplot2)
library(tidyverse)
p = g0.df %>% 
  ggplot(aes(x = tau)) +
  geom_density()
p
```

We want plots of shape and rate, so I will create them in the data frame first
```{r}
g0.df = g0.df %>% 
  mutate(shape = exp(log.Mu)^2 * tau) %>% 
  mutate(rate = exp(log.Mu) * tau)
```

```{r}
p = g0.df %>% 
  ggplot(aes(x = shape))+
  geom_density()
p
```

```{r}
p = g0.df %>% 
  ggplot(aes(x = rate))+
  geom_density()
p
```


```{r}
library(gNanoPkg)
gNano.df = readData()

rateDensity = density(g0.df$rate)
shapeDensity = density(g0.df$shape)

rateMode = rateDensity$x[which.max(rateDensity$y)]
shapeMode = shapeDensity$x[which.max(shapeDensity$y)]

density.df = data.frame(x = seq(1, 30000, 1)) %>% 
  mutate(y = dgamma(x, rate = rateMode, shape = shapeMode))

p = gNano.df %>% 
  ggplot(aes(x = obs, y = stat(density))) + 
  geom_histogram(binwidth = 400) +
  geom_line(data = density.df, aes(x, y))
p
```

Plot the observed vs the expected peak heights

```{r}
expected = g0.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```


## Model $g_1$ - profile effects
```{r g1, echo=FALSE, fig.cap="Model $g_1$", out.width = '25%'}
knitr::include_graphics("g1.png")
```

Let's have a look at the profile effects. I like to use error bar plots 
```{r}
load("../systematic/g-1.Rda")
g1.df = as.data.frame(as.matrix(sim.sample))
```


This code is not elegant, and is probably stupid but then so is the tidyverse a lot of the time :-)
```{r}
lb = g1.df %>% 
    select(starts_with("beta.profile")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = g1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = g1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(profile = 1:102)

p = ggplot(data = quantiles.df, aes(x = profile, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(beta[Profile])) + 
  xlab("Profile")
  
p
```

```{r}
aph = gNano.df %>% 
  group_by(prof) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = g1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = aph, meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth()

p
```


Plot the observed vs the expected peak heights

```{r}
expected = g1.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```

## Model $g_2$ - profile effects
```{r g2, echo=FALSE, fig.cap="Model $g_2$", out.width = '25%'}
knitr::include_graphics("g2.png")
```

```{r}
load("../systematic/g-2.Rda")
g2.df = data.frame(as.matrix(sim.sample[[1]]))

lb = g2.df %>% 
    select(starts_with("alpha.locus")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = g2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = g2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(locus = 1:31)

p = ggplot(data = quantiles.df, aes(x = locus, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(alpha[locus])) + 
  xlab("Locus")
  
p
```
Plot the observed vs the expected peak heights

```{r}
expected = g2.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```