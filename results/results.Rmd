---
title: "Results.Rmd"
author: "James Curran"
date: "28/06/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

loads libraries
```{r}
library(here)
library(rjags)
library(ggplot2)
library(tidyverse)
library(gNanoPkg)
```

Initlaise data

```{r}
gNano.df = readData()
```

## Model $g_0$ - no effects
```{r g0, echo=FALSE, fig.cap="Model $g_0$", out.width = '25%'}
knitr::include_graphics("g0.png")
```

**Model:**
\[
y_{c,l,a} \sim \Gamma(r,s)
\]
If
\[
\mathrm{E}[y_{c,l,a}]) = \log(\mu)\mbox{ and }\mathrm{Var}[y_{c,l,a}] = \sigma^2
\]
then we let
\[
r  = \frac{\mu^2}{\sigma^2}\mbox{ and }s = \frac{\mu}{\sigma^2}
\]
Our prior on $\sigma^2$ is $inverse-\Gamma(0.001, 0.001)$, and our prior on $\log(\mu)$ is $N(0, 10^6)$.

First I will load up the results.

```{r}
load("../systematic/g-0.Rda")
```

Given that we only have one chain, we might as well simultaneously pull the results out of the list, and turn the results into a data frame. This will make our code easier. **Note this type conversion won't work unless rjags is loaded**

```{r}
g0.df = as.data.frame(as.matrix(sim.sample))
```


I'll do this with ggplot2 so I can teach myself something 
```{r}
p = g0.df %>% 
  ggplot(aes(x = tau)) +
  geom_density()
p
```

We want plots of shape and rate, so I will create them in the data frame first as we didn't store them during the sampling
```{r}
g0.df = g0.df %>% 
  mutate(shape = exp(log.Mu)^2 * tau) %>% 
  mutate(rate = exp(log.Mu) * tau)
```

```{r}
p = g0.df %>% 
  ggplot(aes(x = shape))+
  geom_density()
p
```

```{r}
p = g0.df %>% 
  ggplot(aes(x = rate))+
  geom_density()
p
```


```{r}
rateDensity = density(g0.df$rate)
shapeDensity = density(g0.df$shape)

rateMode = rateDensity$x[which.max(rateDensity$y)]
shapeMode = shapeDensity$x[which.max(shapeDensity$y)]

density.df = data.frame(x = seq(1, 30000, 1)) %>% 
  mutate(y = dgamma(x, rate = rateMode, shape = shapeMode))

p = gNano.df %>% 
  ggplot(aes(x = obs, y = stat(density))) + 
  geom_histogram(binwidth = 400) +
  geom_line(data = density.df, aes(x, y))
p
```

Plot the observed vs the expected peak heights

```{r}
expected = g0.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```


## Model $g_1$ - profile effects
```{r g1, echo=FALSE, fig.cap="Model $g_1$", out.width = '25%'}
knitr::include_graphics("g1.png")
```

Let's have a look at the profile effects. I like to use error bar plots 
```{r}
load("../systematic/g-1.Rda")
g1.df = as.data.frame(as.matrix(sim.sample))
```


This code is not elegant, and is probably stupid but then so is the tidyverse a lot of the time :-)
```{r}
lb = g1.df %>% 
    select(starts_with("beta.profile")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = g1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = g1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(profile = 1:102)

p = ggplot(data = quantiles.df, aes(x = profile, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(beta[Profile])) + 
  xlab("Profile")
  
p
```

```{r}
aph = gNano.df %>% 
  group_by(prof) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = g1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = aph, meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth()

p
```


Plot the observed vs the expected peak heights

```{r}
expected = g1.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```

## Model $g_2$ - locus effects
```{r g2, echo=FALSE, fig.cap="Model $g_2$", out.width = '25%'}
knitr::include_graphics("g2.png")
```

```{r}
load("../systematic/g-2.Rda")
g2.df = data.frame(as.matrix(sim.sample[[1]]))

lb = g2.df %>% 
    select(starts_with("alpha.locus")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = g2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = g2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(locus = 1:31)

p = ggplot(data = quantiles.df, aes(x = locus, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(alpha[locus])) + 
  xlab("Locus")
  
p
```

Plot the observed vs the expected peak heights

```{r}
expected = g2.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```

Plot the locus effects by Average Peak Height:

```{r}
aph = gNano.df %>% 
  group_by(loc) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = g2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = aph, meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth()

p
```

## Model $g_3$ - all other effects except extra variance
```{r g3, echo=FALSE, fig.cap="Model $g_2$", out.width = '25%'}
knitr::include_graphics("g3.png")
```

Dye effects

```{r}
load("../systematic/g-3.Rda")
g3.df = data.frame(as.matrix(sim.sample[[1]]))

lb = g3.df %>% 
    select(starts_with("gamma.dye")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = g3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = g3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(dye = 1:4)

p = ggplot(data = quantiles.df, aes(x = dye, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(gamma[dye])) + 
  xlab("Dye")
  
p
```


Plot the dye effects by Average Peak Height - no fitted line here because with four points who cares:

```{r}
aph = gNano.df %>% 
  group_by(dye) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = g3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = aph, meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) 
p
```

Plot the observed vs the expected peak heights

```{r}
expected = g3.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```

## Model $g_4$ - extra variance
```{r g4, echo=FALSE, fig.cap="Model $g_2$", out.width = '25%'}
#knitr::include_graphics("g3.png")
```

Is the added variance being used?

```{r}
load("../systematic/g-4.Rda")
g4.df = data.frame(as.matrix(sim.sample[[1]]))

g4.df = g4.df %>% 
  mutate(sigma.sq0 = 1 / tau0)

p = g4.df %>% 
  ggplot(aes(x = sigma.sq0)) +
  geom_density() + 
  xlab(bquote(sigma[0]^2))

p
```

Plot the observed vs the expected peak heights

```{r}
expected.g4 = g4.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected.g4 = expected.g4, expected.g3 = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(expected.g4))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```

Is it doing anything? 

```{r}
p = plot.df %>% 
  ggplot(aes(x = log10(expected.g3), y = log10(expected.g4))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(2, 5) +
          ylim(2, 5)
p
```

I think it's doing what it is supposed to. 

Let's try and look at the expected values slightly differently. I will work with the summary stats rather than the raw data

```{r}
load("../systematic/g-3.Rda")

g3.quantiles = as.data.frame(t(simSummary$quantiles)) %>% 
  select(starts_with("pred"))  %>%
   rownames_to_column %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  mutate(var = as.numeric(gsub("^pred\\[([0-9]+)\\]$", "\\1", var))) %>% 
  arrange(var)

g3.stats = as.data.frame(t(simSummary$statistics)) %>% 
  select(starts_with("pred"))  %>%
   rownames_to_column %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  mutate(var = as.numeric(gsub("^pred\\[([0-9]+)\\]$", "\\1", var))) %>% 
  arrange(var)



load("../systematic/g-4.Rda")

g4.quantiles = as.data.frame(t(simSummary$quantiles)) %>% 
    select(starts_with("pred"))  %>%
   rownames_to_column %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value)  %>% 
  mutate(var = as.numeric(gsub("^pred\\[([0-9]+)\\]$", "\\1", var))) %>% 
  arrange(var)

plot.df = bind_rows(g3.quantiles, g4.quantiles) %>% 
  mutate(model = rep(c("g3", "g4"), rep(nrow(g3.quantiles), 2))) %>% 
  mutate(obs = rep(gNano.df$obs, 2)) %>% 
  rename(med = `50%`, lb = `2.5%`, ub = `97.5%`) %>% 
  select(obs, model, lb, med, ub) %>% 
  arrange(obs)


p = plot.df %>% 
  ggplot(aes(x = log10(obs), y = log10(med))) +
  facet_grid(vars(model)) +
    geom_abline(aes(intercept = 0, slope = 1)) +
    xlim(2, 5) +
    ylim(2, 5) +
  geom_point(show.legend = FALSE) + 
  geom_smooth() +
  geom_line(aes(y = log10(lb)), col = "green") + geom_line(aes(y = log10(ub)), col = "red")
p
```


Now we move on the the log normal models

## Model $ln_0$ - no effects

Tau

```{r}
load("../systematic/ln-0.Rda")
ln0.df = data.frame(as.matrix(sim.sample[[1]]))

p = ln0.df %>% 
  ggplot(aes(x = tau)) +
  geom_density()
p
```

Mu

```{r}
p = ln0.df %>% 
  ggplot(aes(x = Mu)) +
  geom_density()
p
```

Comparing expected and observed peak heights

```{r}
gNano.df = readData()
expected = ln0.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(exp(expected)))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(0, 5) +
          ylim(0, 5)
p
```

## Model $ln_1$ - profile effects

Load the data

```{r}
load("../systematic/ln-1.Rda")
ln1.df = as.data.frame(as.matrix(sim.sample))
```

Showing the per profile effects

```{r}
lb = ln1.df %>% 
    select(starts_with("beta.profile")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = ln1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = ln1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(profile = 1:102)

p = ggplot(data = quantiles.df, aes(x = profile, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(beta[Profile])) + 
  xlab("Profile")
  
p
```

Now showing the relationship between profile aph and profile effects from model

```{r}
aph = gNano.df %>% 
  group_by(prof) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = ln1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = aph, meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth()

p
```

Plotting observed vs expected peak heights

```{r}
expected = ln1.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(exp(expected)))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(0, 5) +
          ylim(0, 5)
p
```

## Model $ln_2$ - locus effects

```{r}
load("../systematic/ln-2.Rda")
ln2.df = data.frame(as.matrix(sim.sample[[1]]))

lb = ln2.df %>% 
    select(starts_with("alpha.locus")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = ln2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = ln2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(locus = 1:31)

p = ggplot(data = quantiles.df, aes(x = locus, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(alpha[locus])) + 
  xlab("Locus")
  
p
```

Plot the observed vs the expected peak heights
```{r}
expected = ln2.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(exp(expected)))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(0, 5) +
          ylim(0, 5)
p
```

Plot the locus effects by Average Peak Height:

```{r}
aph = gNano.df %>% 
  group_by(loc) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = ln2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = aph, meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth()

p
```

## Model $ln_3$ - all other effects except extra variance

Dye effects

```{r}
load("../systematic/ln-3.Rda")
ln3.df = data.frame(as.matrix(sim.sample[[1]]))

lb = ln3.df %>% 
    select(starts_with("gamma.dye")) %>% 
    summarise_all(quantile, prob = c(0.025)) %>% 
  unlist()

med = ln3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(quantile, prob = c(0.5)) %>% 
  unlist()

ub = ln3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(quantile, prob = c(0.975)) %>% 
  unlist()

quantiles.df = data.frame(lb = lb, med = med, ub = ub) %>% 
  mutate(dye = 1:4)

p = ggplot(data = quantiles.df, aes(x = dye, y = quantiles.df$med)) +
  geom_point(aes(col = "red"), show.legend = FALSE) + 
  geom_errorbar(aes(ymin = lb, ymax = ub)) +
  geom_hline(aes(yintercept=0)) +
  ylab(bquote(gamma[dye])) + 
  xlab("Dye")
  
p
```

Plot the dye effects by Average Peak Height - no fitted line here because with four points who cares:

```{r}
aph = gNano.df %>% 
  group_by(dye) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = ln3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = aph, meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) 
p
```

Plot the observed vs the expected peak heights

```{r}
expected = ln3.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected = expected)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(exp(expected)))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(0, 5) +
          ylim(0, 5)
p
```


## Model $ln_4$ - extra variance

Is the added variance being used?

```{r}
load("../systematic/ln-4.Rda")
ln4.df = data.frame(as.matrix(sim.sample[[1]]))

ln4.df = ln4.df %>% 
  mutate(sigma.sq0 = 1 / tau0)

p = ln4.df %>% 
  ggplot(aes(x = sigma.sq0)) +
  geom_density() + 
  xlab(bquote(sigma[0]^2))

p
```

Plot the observed vs the expected peak heights

```{r}
expected.ln4 = ln4.df %>% 
  select(starts_with("pred")) %>% 
  summarise_all(mean) %>% 
  unlist()
  
plot.df = data.frame(observed = gNano.df$obs, expected.ln4 = expected.ln4)
p = plot.df %>% 
  ggplot(aes(x = log10(observed), y = log10(exp(expected.ln4)))) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(0, 5) +
          ylim(0, 5)
p
```

compare the dlog(likelihoods) for the log-normal model 4 vs the gamma model 4

```{r}
# You need the latest version of tidyr to make this work. 
# The commands to do this are on the next line
# devtools::install_github("tidyverse/tidyr")
library(tidyr)

#loads the gamma model 4
load("../systematic/g-4.Rda")
g4.df = data.frame(as.matrix(sim.sample[[1]]))

sr.df = g4.df %>% 
  select(c(starts_with("shape"), starts_with("rate"))) 

sr.df = sr.df %>% 
  pivot_longer(cols = everything(), names_to = "parameter")
  
nObs = length(gNano.df$obs)

sr.df = sr.df %>% 
  mutate(obs = as.numeric(gsub("^(shape|rate)[.]([0-9]+)[.]$", "\\2", parameter)))

sr.df = sr.df %>% 
  mutate(parameter = gsub("^(shape|rate)[.]([0-9]+)[.]$", "\\1", parameter))

shape.df = sr.df %>% 
  filter(parameter == "shape")

rate.df = sr.df %>% 
  filter(parameter == "rate")

sr.df = data.frame(
  obs = shape.df$obs,
  y = rep(gNano.df$obs, 1000),
  shape = shape.df$value,
  rate = rate.df$value
)

sr.df = sr.df %>% 
  mutate(rep = rep(1:1000, rep(nObs, 1000)))

g4.ll = sr.df %>% 
  group_by(rep) %>% 
  summarise(ll = sum(dgamma(y, shape, rate, log = TRUE)))

p = g4.ll %>% 
  ggplot(aes(x = ll)) + geom_histogram()
p

#loads the log-normal model 4
load("../systematic/ln-4.Rda")
ln4.df = data.frame(as.matrix(sim.sample[[1]]))

ms.df = ln4.df %>% 
  select(c(starts_with("mu", ignore.case = FALSE), matches("^tau[.][0-9]+[.]$"))) 

ms.df = ms.df %>% 
  pivot_longer(cols = everything(), names_to = "parameter")
  
nObs = length(gNano.df$obs)

ms.df = ms.df %>% 
  mutate(obs = as.numeric(gsub("^(mu|tau)[.]([0-9]+)[.]$", "\\2", parameter)))

ms.df = ms.df %>% 
  mutate(parameter = gsub("^(mu|tau)[.]([0-9]+)[.]$", "\\1", parameter))

mu.df = ms.df %>% 
  filter(parameter == "mu")

sigma.df = ms.df %>% 
  filter(parameter == "tau") %>% 
  mutate(sigma = 1 / sqrt(value)) %>% 
  select(-value)

ms.df = data.frame(
  obs = mu.df$obs,
  y = rep(gNano.df$obs, 1000),
  mu = mu.df$value,
  sigma = sigma.df$sigma
)

ms.df = ms.df %>% 
  mutate(rep = rep(1:1000, rep(nObs, 1000)))

ln4.ll = ms.df %>% 
  group_by(rep) %>% 
  summarise(ll = sum(dlnorm(y, mu, sigma, log = TRUE)))

plot.df = left_join(g4.ll, ln4.ll, by = c("rep" = "rep")) %>% 
  rename(g4 = ll.x, ln4 = ll.y) 
# %>% 
#   pivot_longer(cols = c(g4, ln4), names_to = "model")

#plots densities
p = ggplot(plot.df) 
p = p + geom_density(aes(x = g4, col = "red"))
p = p + geom_density(aes(x = ln4, col = "green"))
p

```