---
title: "Results.Rmd"
author: "James Curran"
date: "28/06/2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

loads libraries
```{r}
library(here)
library(rjags)
library(ggplot2)
library(tidyverse)
library(gNanoPkg)
```

Initialise data

```{r}
gNano.df = readData()
```

Specify where the results are stored relative to the gNano project and this file.

```{r}
jamesDuncan = TRUE

resultsRoot = if(jamesDuncan){
    "../systematic/"
  }else{
    "../gNanoPkg/systematic/"
  }
```

## Model $g_0$ - no effects
```{r g0, echo=FALSE, fig.cap="Model $g_0$", out.width = '25%'}
knitr::include_graphics("g0.png")
```

**Model:**
\[
y_{c,l,a} \sim \Gamma(r,s)
\]
If
\[
\mathrm{E}[y_{c,l,a}]) = \log(\mu)\mbox{ and }\mathrm{Var}[y_{c,l,a}] = \sigma^2
\]
then we let
\[
r  = \frac{\mu^2}{\sigma^2}\mbox{ and }s = \frac{\mu}{\sigma^2}
\]
Our prior on $\sigma^2$ is $inverse-\Gamma(0.001, 0.001)$, and our prior on $\log(\mu)$ is $N(0, 10^6)$.

First I will load up the results.

```{r}
g0.df = loadResults("g-0", resultsRoot = resultsRoot)
```


I'll do this with ggplot2 so I can teach myself something 
```{r}
p = g0.df %>% 
  ggplot(aes(x = tau)) +
  geom_density()
p
```

We want plots of shape and rate.

```{r}
p = g0.df %>% 
  ggplot(aes(x = shape))+
  geom_density()
p
```

```{r}
p = g0.df %>% 
  ggplot(aes(x = rate))+
  geom_density()
p
```


```{r}
rateDensity = density(g0.df$rate)
shapeDensity = density(g0.df$shape)

rateMode = rateDensity$x[which.max(rateDensity$y)]
shapeMode = shapeDensity$x[which.max(shapeDensity$y)]

density.df = data.frame(x = seq(1, 30000, 1)) %>% 
  mutate(y = dgamma(x, rate = rateMode, shape = shapeMode))

p = gNano.df %>% 
  ggplot(aes(x = obs, y = stat(density))) + 
  geom_histogram(binwidth = 400) +
  geom_line(data = density.df, aes(x, y))
p
```

Plot the expected vs the observed peak heights

```{r}
obsExpectPlot(g0.df, "g")
```


## Model $g_1$ - profile effects
```{r g1, echo=FALSE, fig.cap="Model $g_1$", out.width = '25%'}
knitr::include_graphics("g1.png")
```

Let's have a look at the profile effects. I like to use error bar plots 
```{r}
g1.df = loadResults("g-1", resultsRoot = resultsRoot)
```


This code is not elegant, and is probably stupid but then so is the tidyverse a lot of the time :-)
```{r}
effectsPlot(g1.df, "profile")
```

```{r}
aph = gNano.df %>% 
  group_by(prof) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = g1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = log10(exp(aph)), meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth() + 
  xlab(expression(log[10]~(aph))) + 
  ylab(bquote(mean~tau[c])) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))

p
```


Plot the expected vs the observed peak heights

```{r}
obsExpectPlot(g1.df, "g")
```

and a pred-res plot

```{r}
obsExpectPlot(g1.df, "g", predRes = TRUE)
```

## Model $g_2$ - locus effects
```{r g2, echo=FALSE, fig.cap="Model $g_2$", out.width = '25%'}
knitr::include_graphics("g2.png")
```

```{r}
g2.df = loadResults("g-2", resultsRoot = resultsRoot)

effectsPlot(g2.df, "locus")
```

Plot the expected vs observed peak heights

```{r}
obsExpectPlot(g2.df, "g")
```

and the pred-res plot

```{r}
obsExpectPlot(g2.df, "g", TRUE)
```


Plot the locus effects by Average Peak Height:

```{r}
aph = gNano.df %>% 
  group_by(loc) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = g2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = log10(exp(aph)), meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth() + 
  xlab(expression(log[10]~(aph))) + 
  ylab(bquote(mean~alpha[l])) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))
p
```

## Model $g_3$ - all other effects except extra variance
```{r g3, echo=FALSE, fig.cap="Model $g_2$", out.width = '25%'}
knitr::include_graphics("g3.png")
```

Dye effects

```{r}
g3.df = loadResults("g-3", resultsRoot = resultsRoot)

effectsPlot(g3.df, "dye")
```


Plot the dye effects by Average Peak Height - no fitted line here because with four points who cares:

```{r}
aph = gNano.df %>% 
  group_by(dye) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = g3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = log10(exp(aph)), meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth() + 
  xlab(expression(log[10]~(aph))) + 
  ylab(bquote(mean~delta[f])) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))
p
```

Plot the expected vs observed peak heights

```{r}
obsExpectPlot(g3.df, "g")
```
and the pred-res plot

```{r}
g3.predRes = obsExpectPlot(g3.df, "g", TRUE)
```

## Model $g_4$ - extra variance
```{r g4, echo=FALSE, fig.cap="Model $g_2$", out.width = '25%'}
#knitr::include_graphics("g3.png")
```

Is the added variance being used?

```{r}
g4.df = loadResults("g-4", resultsRoot = resultsRoot)

g4.df = g4.df %>% 
  mutate(sigma.sq0 = 1 / tau0)

p = g4.df %>% 
  ggplot(aes(x = sigma.sq0/10^6)) +
  geom_density() +
  geom_vline(xintercept = quantile(g4.df$sigma.sq0/10^6, probs=0.025)) +
  geom_vline(xintercept = quantile(g4.df$sigma.sq0/10^6, probs=0.975)) +
  xlab(bquote(sigma[0]^2~(x10^6))) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))
p
```

Plot the expected vs observed peak heights

```{r}
obsExpectPlot(g4.df, "g")
```
And the pred-res plot

```{r}
g4.predRes = obsExpectPlot(g4.df, "g", TRUE)
```

Is it doing anything? 

```{r}
plot.df = data.frame(
  expected.g3 = g3.predRes$plot.df$mean,
  expected.g4 = g4.predRes$plot.df$mean
)
p = plot.df %>% 
  ggplot(aes(x = expected.g3, y = expected.g4)) +
           geom_point() +
           geom_abline(aes(intercept = 0, slope = 1)) + 
          xlim(1, 5) +
          ylim(1, 5)
p
```

I think it's doing what it is supposed to. 

Let's try and look at the expected values slightly differently. I will work with the summary stats rather than the raw data

```{r}
simSummary = loadResults("g-3", resultsRoot = resultsRoot, summary = TRUE)

g3.quantiles = as.data.frame(t(simSummary$quantiles)) %>% 
  select(starts_with("pred"))  %>%
   rownames_to_column %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  mutate(var = as.numeric(gsub("^pred\\[([0-9]+)\\]$", "\\1", var))) %>% 
  arrange(var)

g3.stats = as.data.frame(t(simSummary$statistics)) %>% 
  select(starts_with("pred"))  %>%
   rownames_to_column %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value) %>% 
  mutate(var = as.numeric(gsub("^pred\\[([0-9]+)\\]$", "\\1", var))) %>% 
  arrange(var)



simSummary = loadResults("g-4", resultsRoot = resultsRoot, summary = TRUE)

g4.quantiles = as.data.frame(t(simSummary$quantiles)) %>% 
    select(starts_with("pred"))  %>%
   rownames_to_column %>% 
   gather(var, value, -rowname) %>% 
   spread(rowname, value)  %>% 
  mutate(var = as.numeric(gsub("^pred\\[([0-9]+)\\]$", "\\1", var))) %>% 
  arrange(var)

plot.df = bind_rows(g3.quantiles, g4.quantiles) %>% 
  mutate(model = rep(c("g3", "g4"), rep(nrow(g3.quantiles), 2))) %>% 
  mutate(obs = rep(gNano.df$obs, 2)) %>% 
  rename(med = `50%`, lb = `2.5%`, ub = `97.5%`) %>% 
  select(obs, model, lb, med, ub) %>% 
  arrange(obs)


p = plot.df %>% 
  ggplot(aes(x = log10(obs), y = log10(med))) +
  facet_grid(vars(model)) +
    geom_abline(aes(intercept = 0, slope = 1)) +
    xlim(1, 5) +
    ylim(1, 5) +
  geom_point(show.legend = FALSE) + 
  geom_smooth() +
  geom_line(aes(y = log10(lb)), col = "green") + geom_line(aes(y = log10(ub)), col = "red")
p
```


Now we move on the the log normal models

## Model $ln_0$ - no effects

Tau

```{r}
ln0.df = loadResults("ln-0", resultsRoot = resultsRoot)

p = ln0.df %>% 
  ggplot(aes(x = tau)) +
  geom_density()
p
```

Mu

```{r}
p = ln0.df %>% 
  ggplot(aes(x = Mu)) +
  geom_density()
p
```

Comparing expected and observed peak heights

```{r}
obsExpectPlot(ln0.df, "ln")
```
and the pred-res plot

```{r}
obsExpectPlot(ln0.df, "ln", TRUE)
```

## Model $ln_1$ - profile effects

Load the data

```{r}
ln1.df = loadResults("ln-1", resultsRoot = resultsRoot)
```

Showing the per profile effects

```{r}
effectsPlot(ln1.df, "profile")
```

Now showing the relationship between profile aph and profile effects from model

```{r}
aph = gNano.df %>% 
  group_by(prof) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = ln1.df %>% 
  select(starts_with("beta.profile")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = log10(exp(aph)), meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth() +
  xlab(expression(log[10]~(aph))) + 
  ylab(bquote(mean~tau[c])) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))
p
```

Plotting observed vs expected peak heights

```{r}
obsExpectPlot(ln1.df, "ln")
```
and the pred-res plot

```{r}
obsExpectPlot(ln1.df, "ln", TRUE)
```
## Model $ln_2$ - locus effects

```{r}
ln2.df = loadResults("ln-2", resultsRoot = resultsRoot)

effectsPlot(ln2.df, "locus")
```

Plot the expected vs observed peak heights
```{r}
obsExpectPlot(ln2.df, "ln")
```
and the pred-res
```{r}
obsExpectPlot(ln2.df, "ln", TRUE)
```


Plot the locus effects by Average Peak Height:

```{r}
aph = gNano.df %>% 
  group_by(loc) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = ln2.df %>% 
  select(starts_with("alpha.locus")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = log10(exp(aph)), meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth() +
  xlab(expression(log[10]~(aph))) + 
  ylab(bquote(mean~alpha[l])) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))
p
```

## Model $ln_3$ - all other effects except extra variance

Dye effects

```{r}
ln3.df = loadResults("ln-3", resultsRoot = resultsRoot)
effectsPlot(ln3.df, "dye")
```

Plot the dye effects by Average Peak Height - no fitted line here because with four points who cares:

```{r}
aph = gNano.df %>% 
  group_by(dye) %>% 
  summarise(aph = mean(log(obs), na.rm = TRUE)) %>% 
  pull(aph)


meanEffect = ln3.df %>% 
  select(starts_with("gamma.dye")) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  unlist()
  
plot.df = data.frame(aph = log10(exp(aph)), meanEffect = meanEffect)
p = plot.df %>% 
  ggplot(aes(x = aph, y = meanEffect)) + 
  geom_point(show.legend = FALSE) +
  geom_smooth() +
  xlab(expression(log[10]~(aph))) + 
  ylab(bquote(mean~delta[f])) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))
p
```

Plot the expected vs observed peak heights

```{r}
obsExpectPlot(ln3.df, "ln")
```
and the pred-res
```{r}
obsExpectPlot(ln3.df, "ln", TRUE)
```

## Model $ln_4$ - extra variance

Is the added variance being used?

```{r}
ln4.df = loadResults("ln-4", resultsRoot = resultsRoot)

ln4.df = ln4.df %>% 
  mutate(sigma.sq0 = 1 / tau0)

p = ln4.df %>% 
  ggplot(aes(x = sigma.sq0)) +
  geom_density() +
  geom_vline(xintercept = quantile(ln4.df$sigma.sq0, probs=0.025)) +
  geom_vline(xintercept = quantile(ln4.df$sigma.sq0, probs=0.975)) +
  xlab(bquote(sigma[0]^2)) + 
  theme(text = element_text(size = 20), aspect.ratio = 1, plot.background = element_rect(color="black"))
p
```

Plot the expected vs observed peak heights

```{r}
obsExpectPlot(ln4.df, "ln")
```
And the pred-res

```{r}
obsExpectPlot(ln4.df, "ln", TRUE)
```
Compare the dlog(likelihoods) for the log-normal model 4 vs the gamma model 4

```{r}
ln4.ll = calcLogLik(ln4.df, "ln")
g4.ll = calcLogLik(g4.df, "g")
compareLL(ln4.ll, g4.ll, labels = c("LN-4", "G-4"))
```


Comparing the g3 model and the g4 model
```{r}
g3.ll = calcLogLik(g3.df, "g")
compareLL(g3.ll, g4.ll, labels = c("G-3", "G-4"))
```

Compare the ln3 and ln4 models

```{r}
ln3.ll = calcLogLik(ln3.df, "ln")
compareLL(ln3.ll, ln4.ll, labels = c("LN-3", "LN-4"))
```

Compare all the ln models at once:

```{r}
ln0.ll = calcLogLik(ln0.df, "ln")
ln1.ll = calcLogLik(ln1.df, "ln")
ln2.ll = calcLogLik(ln2.df, "ln")
compareLL(ln0.ll, ln1.ll, ln2.ll, ln3.ll, ln4.ll,
          labels = paste0("LN-", 0:4))
```
LN-0 kind of distorts this so, let's drop it.

```{r}
compareLL(ln1.ll, ln2.ll, ln3.ll, ln4.ll,
          labels = paste0("LN-", 1:4))
```
So no real value in the variance model. Definite gains in adding in dye and locus effects (and profile, but we don't care about those).


## Does the removal of sum constraints matter?

```{r}
ln5.df = loadResults("ln-5", resultsRoot = resultsRoot)
```


